#!/usr/bin/env zsh
# ä¼˜åŒ–ç‰ˆ zshrc é…ç½® - è‡ªåŠ¨å®‰è£…ä¾èµ–å¹¶æ˜¾ç¤ºè¿›åº¦æ¡
# ä½œè€…: Claude
# ç‰ˆæœ¬: 3.0

# åŸºç¡€é…ç½®
typeset -U PATH
# æ·»åŠ å¸¸ç”¨è·¯å¾„ï¼ŒåŒ…æ‹¬ Homebrew å¯èƒ½çš„ä½ç½®
export PATH="/usr/bin:/bin:/usr/sbin:/sbin:$HOME/bin:/usr/local/bin:/opt/homebrew/bin:/usr/local/bin"

# å¯ç”¨ zsh æ¨¡å—
zmodload zsh/mapfile
zmodload zsh/datetime

# ç¼“å­˜ç›®å½• - ç”¨äºå­˜å‚¨å®‰è£…çŠ¶æ€å’Œé…ç½®
ZSH_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/zsh"
[[ ! -d "$ZSH_CACHE_DIR" ]] && mkdir -p "$ZSH_CACHE_DIR"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# å·¥å…·å‡½æ•°: æ˜¾ç¤ºå½©è‰²è¿›åº¦æ¡
show_progress() {
  local width=40
  local percent=$1
  local filled=$((width * percent / 100))
  local empty=$((width - filled))
  local message=${2:-""}
  
  # ä½¿ç”¨ ANSI é¢œè‰²ä»£ç ä½¿è¿›åº¦æ¡æ›´ç¾è§‚
  printf "\r${BLUE}[${NC}"
  printf "${GREEN}%${filled}s${NC}" | tr ' ' '#'
  printf "${GRAY}%${empty}s${NC}" | tr ' ' 'Â·'
  printf "${BLUE}]${NC} ${YELLOW}%3d%%${NC} %s" $percent "$message"
}

# å·¥å…·å‡½æ•°: æ˜¾ç¤ºå®‰è£…è¿›åº¦
show_install_progress() {
  local tool_name=$1
  local log_file="$ZSH_CACHE_DIR/${tool_name}_install.log"
  local temp_file="$ZSH_CACHE_DIR/${tool_name}_temp.log"
  local status_file="$ZSH_CACHE_DIR/${tool_name}_status"
  local start_time=$(date +%s)
  local spinner=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
  local i=0
  
  # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºè·Ÿè¸ªè¿›åº¦
  touch "$temp_file"
  
  echo -e "\n${YELLOW}å¼€å§‹å®‰è£… $tool_name...${NC}"
  
  while [[ ! -f "$status_file" || "$(cat "$status_file")" == "installing" ]]; do
    # æ˜¾ç¤ºæœ€æ–°çš„æ—¥å¿—å†…å®¹
    if [[ -f "$log_file" ]]; then
      local new_content=$(tail -n 5 "$log_file" 2>/dev/null | grep -v "^$" | tail -n 1)
      if [[ -n "$new_content" && "$new_content" != "$(tail -n 1 "$temp_file" 2>/dev/null)" ]]; then
        echo "$new_content" >> "$temp_file"
        echo -e "${GRAY}$new_content${NC}"
      fi
    fi
    
    # æ˜¾ç¤ºæ—‹è½¬åŠ¨ç”»
    local current_time=$(date +%s)
    local elapsed=$((current_time - start_time))
    printf "\r${BLUE}${spinner[$i]}${NC} ${YELLOW}å®‰è£…ä¸­...${NC} ${GRAY}å·²ç”¨æ—¶é—´: ${elapsed}s${NC}  "
    i=$(( (i+1) % ${#spinner[@]} ))
    sleep 0.1
    
    # æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
    if [[ -f "$status_file" && "$(cat "$status_file")" != "installing" ]]; then
      break
    fi
    
    # æ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
    if [[ $elapsed -gt 300 ]]; then
      echo -e "\n${RED}å®‰è£…è¶…æ—¶ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è¾“å…¥å¯†ç æˆ–å¤„ç†å…¶ä»–é—®é¢˜${NC}"
      echo -e "${YELLOW}è¯·æ£€æŸ¥ç»ˆç«¯æ˜¯å¦æœ‰éœ€è¦è¾“å…¥çš„æç¤º${NC}"
      break
    fi
  done
  
  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  rm -f "$temp_file"
  
  # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
  if [[ -f "$status_file" ]]; then
    local final_status=$(cat "$status_file")
    if [[ "$final_status" == "installed" ]]; then
      echo -e "\n${GREEN}âœ“ $tool_name å®‰è£…æˆåŠŸ${NC}"
      return 0
    elif [[ "$final_status" == "failed" ]]; then
      echo -e "\n${RED}âœ— $tool_name å®‰è£…å¤±è´¥${NC}"
      echo -e "${YELLOW}æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: $log_file${NC}"
      return 1
    fi
  fi
  
  echo -e "\n${YELLOW}? $tool_name å®‰è£…çŠ¶æ€æœªçŸ¥${NC}"
  return 2
}

# å·¥å…·å‡½æ•°: è¯¢é—®ç”¨æˆ·æ˜¯å¦å®‰è£…
ask_install() {
  local tool_name=$1
  local description=$2
  
  echo -e "${YELLOW}æœªæ£€æµ‹åˆ° $tool_name${NC} - $description"
  echo -ne "${CYAN}æ˜¯å¦å®‰è£…? (y/n) ${NC}"
  read -r response
  
  if [[ "$response" =~ ^[Yy]$ ]]; then
    return 0
  else
    return 1
  fi
}

# å·¥å…·å‡½æ•°: æ£€æŸ¥å·¥å…·å®‰è£…çŠ¶æ€
check_tool_status() {
  local tool_name=$1
  local status_file="$ZSH_CACHE_DIR/${tool_name}_status"
  
  if [[ -f "$status_file" ]]; then
    cat "$status_file"
  else
    echo "unknown"
  fi
}

# å·¥å…·å‡½æ•°: åå°å®‰è£…å·¥å…·
install_tool_bg() {
  local tool_name=$1
  local install_cmd=$2
  local post_install=$3
  local log_file="$ZSH_CACHE_DIR/${tool_name}_install.log"
  local status_file="$ZSH_CACHE_DIR/${tool_name}_status"
  
  # å¦‚æœå·²ç»åœ¨å®‰è£…ä¸­ï¼Œä¸è¦é‡å¤å¯åŠ¨
  if [[ -f "$status_file" && "$(cat "$status_file")" == "installing" ]]; then
    echo -e "${YELLOW}âš ï¸ $tool_name å·²åœ¨å®‰è£…ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ${NC}"
    return
  fi
  
  echo "installing" > "$status_file"
  
  # è®°å½•å¼€å§‹æ—¶é—´
  echo "å®‰è£…å¼€å§‹: $(date)" > "$log_file"
  
  # åœ¨åå°æ‰§è¡Œå®‰è£…å‘½ä»¤
  {
    # æ‰§è¡Œå®‰è£…å‘½ä»¤
    eval "$install_cmd" >> "$log_file" 2>&1
    exit_code=$?
    
    if [[ $exit_code -eq 0 ]]; then
      if [[ -n "$post_install" ]]; then
        echo "æ‰§è¡Œå®‰è£…åé…ç½®..." >> "$log_file"
        eval "$post_install" >> "$log_file" 2>&1
        post_exit_code=$?
        
        if [[ $post_exit_code -ne 0 ]]; then
          echo "âš ï¸ $tool_name å®‰è£…åé…ç½®å¤±è´¥" >> "$log_file"
          echo "failed" > "$status_file"
          return
        fi
      fi
      
      echo "âœ… $tool_name å®‰è£…æˆåŠŸ" >> "$log_file"
      echo "installed" > "$status_file"
    else
      echo "âŒ $tool_name å®‰è£…å¤±è´¥ï¼Œé”™è¯¯ä»£ç : $exit_code" >> "$log_file"
      echo "failed" > "$status_file"
    fi
    
    echo "å®‰è£…ç»“æŸ: $(date)" >> "$log_file"
  } &
  
  # æ˜¾ç¤ºå®‰è£…è¿›åº¦
  show_install_progress "$tool_name"
  
  # è¿”å›å®‰è£…çŠ¶æ€
  if [[ -f "$status_file" && "$(cat "$status_file")" == "installed" ]]; then
    return 0
  else
    return 1
  fi
}

# å·¥å…·å‡½æ•°: æ£€æŸ¥å¹¶å®‰è£…å·¥å…· - äº¤äº’å¼
ensure_installed() {
  local tool_name=$1
  local check_cmd=$2
  local install_cmd=$3
  local post_install=$4
  local description=$5
  local auto_install=${6:-false}
  
  # é¦–å…ˆæ£€æŸ¥å‘½ä»¤æ˜¯å¦å¯ç”¨
  if eval "$check_cmd" &> /dev/null; then
    echo "installed" > "$ZSH_CACHE_DIR/${tool_name}_status"
    echo -e "${GREEN}âœ“ $tool_name å·²å®‰è£…${NC}"
    return 0  # å·²å®‰è£…
  fi
  
  # æ£€æŸ¥å®‰è£…çŠ¶æ€
  local install_status=$(check_tool_status "$tool_name")
  
  case "$install_status" in
    "installed")
      # çŠ¶æ€æ–‡ä»¶è¯´å·²å®‰è£…ï¼Œä½†å‘½ä»¤ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯çŠ¶æ€æ–‡ä»¶è¿‡æ—¶
      if ! eval "$check_cmd" &> /dev/null; then
        echo "unknown" > "$ZSH_CACHE_DIR/${tool_name}_status"
        echo -e "${YELLOW}âš ï¸ $tool_name çŠ¶æ€æ–‡ä»¶è¿‡æ—¶${NC}"
      else
        echo -e "${GREEN}âœ“ $tool_name å·²å®‰è£…${NC}"
        return 0
      fi
      ;;
    "installing")
      # æ­£åœ¨å®‰è£…ä¸­
      echo -e "${BLUE}ğŸ”„ $tool_name æ­£åœ¨å®‰è£…ä¸­...${NC}"
      show_install_progress "$tool_name"
      if eval "$check_cmd" &> /dev/null; then
        echo "installed" > "$ZSH_CACHE_DIR/${tool_name}_status"
        echo -e "${GREEN}âœ“ $tool_name å·²å®‰è£…${NC}"
        return 0
      else
        return 2
      fi
      ;;
    "failed")
      # ä¹‹å‰å®‰è£…å¤±è´¥
      echo -e "${RED}âœ— $tool_name ä¹‹å‰å®‰è£…å¤±è´¥${NC}"
      ;;
  esac
  
  # è¯¢é—®ç”¨æˆ·æ˜¯å¦å®‰è£…
  if [[ "$auto_install" == true ]] || ask_install "$tool_name" "$description"; then
    echo -e "${BLUE}ğŸ”„ å¼€å§‹å®‰è£… $tool_name...${NC}"
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦ sudo
    if [[ "$install_cmd" == *"sudo"* ]]; then
      echo -e "${YELLOW}âš ï¸ æ­¤å®‰è£…å¯èƒ½éœ€è¦è¾“å…¥å¯†ç ${NC}"
    fi
    
    install_tool_bg "$tool_name" "$install_cmd" "$post_install"
    
    # æ£€æŸ¥å®‰è£…ç»“æœ
    if eval "$check_cmd" &> /dev/null; then
      echo "installed" > "$ZSH_CACHE_DIR/${tool_name}_status"
      echo -e "${GREEN}âœ“ $tool_name å®‰è£…æˆåŠŸ${NC}"
      return 0
    else
      echo -e "${RED}âœ— $tool_name å®‰è£…å¤±è´¥${NC}"
      return 1
    fi
  else
    echo -e "${YELLOW}âš ï¸ è·³è¿‡å®‰è£… $tool_name${NC}"
    return 1
  fi
}

# åˆå§‹åŒ–å·¥å…·åˆ—è¡¨ - ä½¿ç”¨å…³è”æ•°ç»„
typeset -A tools_to_install
tools_to_install=(
  ["homebrew"]="macOS åŒ…ç®¡ç†å™¨ï¼Œç”¨äºå®‰è£…å…¶ä»–å·¥å…·"
  ["fnm"]="Node.js ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç†ä¸åŒç‰ˆæœ¬çš„ Node.js"
  ["oh-my-zsh"]="ZSH é…ç½®ç®¡ç†æ¡†æ¶ï¼Œæä¾›æ’ä»¶å’Œä¸»é¢˜æ”¯æŒ"
  ["zsh-syntax-highlighting"]="ZSH è¯­æ³•é«˜äº®æ’ä»¶"
  ["zsh-autosuggestions"]="ZSH å‘½ä»¤è‡ªåŠ¨å»ºè®®æ’ä»¶"
  ["z"]="ç›®å½•å¿«é€Ÿè·³è½¬å·¥å…·"
)

# æ£€æŸ¥å¿…è¦å·¥å…· - äº¤äº’å¼
check_required_tools() {
  echo -e "${BLUE}=== æ£€æŸ¥å¿…è¦å·¥å…· ===${NC}"
  
  # æ£€æŸ¥ Homebrew - æ£€æŸ¥å‘½ä»¤å’Œå®‰è£…ç›®å½•
  if command -v brew &> /dev/null || [[ -d "/opt/homebrew" ]] || [[ -d "/usr/local/Homebrew" ]]; then
    # Homebrew å·²å®‰è£…ï¼Œç¡®ä¿çŠ¶æ€æ–‡ä»¶æ­£ç¡®
    echo "installed" > "$ZSH_CACHE_DIR/homebrew_status"
    echo -e "${GREEN}âœ“ Homebrew å·²å®‰è£…${NC}"
  else
    local brew_status=$(check_tool_status "homebrew")
    if [[ "$brew_status" == "installing" ]]; then
      echo -e "${BLUE}ğŸ”„ Homebrew æ­£åœ¨å®‰è£…ä¸­...${NC}"
      show_install_progress "homebrew"
    elif [[ "$brew_status" != "installed" ]]; then
      if ask_install "Homebrew" "macOS åŒ…ç®¡ç†å™¨ï¼Œç”¨äºå®‰è£…å…¶ä»–å·¥å…·"; then
        echo -e "${YELLOW}âš ï¸ Homebrew å®‰è£…å¯èƒ½éœ€è¦è¾“å…¥å¯†ç ${NC}"
        install_tool_bg "homebrew" '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"' 'if [[ -f /opt/homebrew/bin/brew ]]; then eval "$(/opt/homebrew/bin/brew shellenv)"; elif [[ -f /usr/local/bin/brew ]]; then eval "$(/usr/local/bin/brew shellenv)"; fi'
      fi
    fi
  fi
  
  # ç¡®ä¿ Homebrew ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
  if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
    echo -e "${GREEN}âœ“ ä½¿ç”¨ Apple Silicon Homebrew (/opt/homebrew)${NC}"
  elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
    echo -e "${GREEN}âœ“ ä½¿ç”¨ Intel Homebrew (/usr/local)${NC}"
  fi
  
  # æ£€æŸ¥ oh-my-zsh
  if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    ensure_installed "oh-my-zsh" "test -d $HOME/.oh-my-zsh" 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended' "setup_omz" "ZSH é…ç½®ç®¡ç†æ¡†æ¶ï¼Œæä¾›æ’ä»¶å’Œä¸»é¢˜æ”¯æŒ"
  else
    echo "installed" > "$ZSH_CACHE_DIR/oh-my-zsh_status"
    echo -e "${GREEN}âœ“ oh-my-zsh å·²å®‰è£…${NC}"
  fi

  # æ£€æŸ¥ zsh-syntax-highlighting æ’ä»¶
  if [[ ! -d "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting" ]]; then
    ensure_installed "zsh-syntax-highlighting" "test -d ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting" "git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting" "" "ZSH è¯­æ³•é«˜äº®æ’ä»¶"
  else
    echo "installed" > "$ZSH_CACHE_DIR/zsh-syntax-highlighting_status"
    echo -e "${GREEN}âœ“ zsh-syntax-highlighting å·²å®‰è£…${NC}"
  fi

  # æ£€æŸ¥ zsh-autosuggestions æ’ä»¶
  if [[ ! -d "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" ]]; then
    ensure_installed "zsh-autosuggestions" "test -d ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" "git clone https://github.com/zsh-users/zsh-autosuggestions.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" "" "ZSH å‘½ä»¤è‡ªåŠ¨å»ºè®®æ’ä»¶"
  else
    echo "installed" > "$ZSH_CACHE_DIR/zsh-autosuggestions_status"
    echo -e "${GREEN}âœ“ zsh-autosuggestions å·²å®‰è£…${NC}"
  fi

  # æ£€æŸ¥ z æ’ä»¶
  if command -v brew &> /dev/null; then
    ensure_installed "z" "brew list z &>/dev/null" "brew install z" "" "ç›®å½•å¿«é€Ÿè·³è½¬å·¥å…·"
  else
    # å¦‚æœæ²¡æœ‰brewï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½zåˆ°customç›®å½•
    if [[ ! -d "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/z" ]]; then
      ensure_installed "z" "test -d ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/z" "mkdir -p ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/z && curl -fsSL https://raw.githubusercontent.com/rupa/z/master/z.sh -o ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/z/z.sh" "" "ç›®å½•å¿«é€Ÿè·³è½¬å·¥å…·"
    else
      echo "installed" > "$ZSH_CACHE_DIR/z_status"
      echo -e "${GREEN}âœ“ z å·²å®‰è£…${NC}"
    fi
  fi
  
  # æ£€æŸ¥ fnm - æ›´å…¨é¢çš„æ£€æµ‹
  if command -v fnm &>/dev/null || [[ -x "/opt/homebrew/bin/fnm" ]] || [[ -x "/usr/local/bin/fnm" ]] || [[ -x "$HOME/.fnm/fnm" ]]; then
    echo "installed" > "$ZSH_CACHE_DIR/fnm_status"
    echo -e "${GREEN}âœ“ fnm å·²å®‰è£…${NC}"
    # ç¡®ä¿ fnm ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
    setup_fnm
  else
    ensure_installed "fnm" "command -v fnm" "brew install fnm" "setup_fnm" "Node.js ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç†ä¸åŒç‰ˆæœ¬çš„ Node.js"
  fi
  
  echo -e "${BLUE}=== æ£€æŸ¥å®Œæˆ ===${NC}\n"
}

# fnm è®¾ç½®å‡½æ•° - ç”¨äºå®‰è£…åé…ç½®
setup_fnm() {
  # æ·»åŠ  fnm åˆ° PATH - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
  local fnm_paths=(
    "$HOME/.fnm"
    "/opt/homebrew/bin"
    "/usr/local/bin"
  )
  
  for fnm_path in "${fnm_paths[@]}"; do
    if [[ -d "$fnm_path" && -x "$fnm_path/fnm" ]]; then
      export PATH="$fnm_path:$PATH"
      break
    fi
  done
  
  # å¦‚æœä¹‹å‰æœ‰ nvmï¼Œè‡ªåŠ¨å¯¼å…¥å·²æœ‰çš„ node ç‰ˆæœ¬
  if [[ -d "$HOME/.nvm" ]]; then
    echo -e "${BLUE}æ£€æµ‹åˆ° nvmï¼Œæ­£åœ¨å¯¼å…¥ç°æœ‰ Node.js ç‰ˆæœ¬...${NC}"
    for version in $(ls -1 $HOME/.nvm/versions/node 2>/dev/null); do
      command fnm import --node-dir "$HOME/.nvm/versions/node/$version" &>/dev/null
    done
  fi
  
  # è®¾ç½® fnm ç¯å¢ƒå˜é‡ - ä½¿ç”¨ command å‰ç¼€é¿å…é€’å½’
  if command -v fnm &>/dev/null; then
    eval "$(command fnm env --use-on-cd)" 2>/dev/null || true
  fi
  
  echo -e "${GREEN}âœ“ fnm ç¯å¢ƒå·²é…ç½®${NC}"
  return 0
}

# fnm åŠ è½½å‡½æ•° - ç”¨äºæŒ‰éœ€åŠ è½½
load_fnm() {
  # é™é»˜æ¨¡å¼æ ‡å¿— - é¿å…é‡å¤è¾“å‡º
  local silent=${1:-false}
  
  # å¦‚æœ fnm å·²ç»åœ¨ PATH ä¸­ï¼Œç›´æ¥è¿”å›
  if command -v fnm &>/dev/null; then
    # ç¡®ä¿ fnm ç¯å¢ƒå˜é‡å·²è®¾ç½®
    eval "$(command fnm env --use-on-cd)" 2>/dev/null || true
    [[ "$silent" == "false" ]] && echo -e "${GREEN}âœ“ fnm ç¯å¢ƒå·²åŠ è½½${NC}"
    return 0
  fi
  
  # æ£€æŸ¥ fnm å®‰è£…ä½ç½®å¹¶æ·»åŠ åˆ° PATH
  local fnm_paths=(
    "$HOME/.fnm"
    "/opt/homebrew/bin"
    "/usr/local/bin"
  )
  
  local fnm_found=false
  for fnm_path in "${fnm_paths[@]}"; do
    if [[ -x "$fnm_path/fnm" ]]; then
      export PATH="$fnm_path:$PATH"
      fnm_found=true
      break
    fi
  done
  
  if [[ "$fnm_found" == true ]]; then
    # è®¾ç½® fnm ç¯å¢ƒå˜é‡ - ä½¿ç”¨ command å‰ç¼€é¿å…é€’å½’
    eval "$(command fnm env --use-on-cd)" 2>/dev/null || true
    [[ "$silent" == "false" ]] && echo -e "${GREEN}âœ“ fnm ç¯å¢ƒå·²åŠ è½½${NC}"
    return 0
  fi
  
  # å¦‚æœ fnm æœªå®‰è£…ä¸”ä¸æ˜¯é™é»˜æ¨¡å¼ï¼Œå°è¯•å®‰è£…
  if [[ "$silent" == "false" ]]; then
    echo -e "${YELLOW}âš ï¸ fnm æœªå®‰è£…ï¼Œæ­£åœ¨å°è¯•å®‰è£…...${NC}"
    ensure_installed "fnm" "command -v fnm" "brew install fnm" "setup_fnm" "Node.js ç‰ˆæœ¬ç®¡ç†å™¨" true
    
    # å†æ¬¡æ£€æŸ¥ fnm æ˜¯å¦å¯ç”¨
    if command -v fnm &>/dev/null; then
      eval "$(command fnm env --use-on-cd)" 2>/dev/null || true
      echo -e "${GREEN}âœ“ fnm å·²å®‰è£…å¹¶åŠ è½½${NC}"
      return 0
    else
      echo -e "${RED}âœ— æ— æ³•åŠ è½½ fnm${NC}"
      return 1
    fi
  fi
  
  return 1
}

# oh-my-zsh è®¾ç½®å‡½æ•°
setup_omz() {
  # é…ç½® oh-my-zsh
  export ZSH="$HOME/.oh-my-zsh"
  
  # è®¾ç½®ä¸»é¢˜ - ä½¿ç”¨é»˜è®¤çš„robbyrussellï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ›´æ¢
  ZSH_THEME="robbyrussell"
  
  # ç¦ç”¨è‡ªåŠ¨æ›´æ–°æç¤º
  DISABLE_AUTO_UPDATE="true"
  
  # é…ç½®æ’ä»¶
  plugins=(
    git
    z
    zsh-syntax-highlighting
    zsh-autosuggestions
  )
  
  # åŠ è½½ oh-my-zsh
  if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh"
    return 0
  fi
  
  return 1
}

# Node.js å®‰è£…å‡½æ•°
install_node() {
  local version=${1:-"lts"}
  
  # ç¡®ä¿ fnm å·²åŠ è½½ - ä½¿ç”¨é™é»˜æ¨¡å¼
  load_fnm true || return 1
  
  echo -e "${BLUE}ğŸ”„ æ­£åœ¨å®‰è£… Node.js $version...${NC}"
  
  # å®‰è£…æŒ‡å®šç‰ˆæœ¬ - ä½¿ç”¨ command å‰ç¼€é¿å…é€’å½’
  if [[ "$version" == "lts" ]]; then
    command fnm install --lts
    command fnm default $(command fnm list | grep lts | head -n1 | awk '{print $2}')
  else
    command fnm install $version
    command fnm default $version
  fi
  
  # æ£€æŸ¥å®‰è£…ç»“æœ
  if command -v node &>/dev/null; then
    echo -e "${GREEN}âœ“ Node.js $(node -v) å®‰è£…æˆåŠŸ${NC}"
    return 0
  else
    echo -e "${RED}âœ— Node.js å®‰è£…å¤±è´¥${NC}"
    return 1
  fi
}

# å‘½ä»¤åŒ…è£…å‡½æ•° - æ”¹è¿›ç‰ˆæœ¬é¿å…é€’å½’è°ƒç”¨
wrap_command() {
  local cmd=$1
  local load_func=$2
  
  eval "function $cmd() {
    $load_func true  # é™é»˜æ¨¡å¼åŠ è½½
    command $cmd \"\$@\"
  }"
}

# åˆ›å»ºå‘½ä»¤åˆ«åæ¥è§¦å‘ç¯å¢ƒåŠ è½½ - ä¸åŒ…è£… fnm æœ¬èº«
wrap_command "node" "load_fnm"
wrap_command "npm" "load_fnm"
wrap_command "npx" "load_fnm"
wrap_command "yarn" "load_fnm"
wrap_command "pnpm" "load_fnm"

# ç¡®ä¿ fnm å‘½ä»¤å¯ç”¨ - åœ¨ shell å¯åŠ¨æ—¶é¢„åŠ è½½
if ! command -v fnm &>/dev/null; then
  # å°è¯•æ·»åŠ  fnm åˆ° PATH
  for fnm_path in "$HOME/.fnm" "/opt/homebrew/bin" "/usr/local/bin"; do
    if [[ -x "$fnm_path/fnm" ]]; then
      export PATH="$fnm_path:$PATH"
      break
    fi
  done
fi

# åˆå§‹åŒ–é…ç½®
init_config() {
  echo -e "${BLUE}=== åˆå§‹åŒ– zsh é…ç½® ===${NC}"
  
  # è®¾ç½®ä¸´æ—¶æç¤ºç¬¦
  PS1='%F{cyan}%~%f %F{green}â¯%f '
  
  # æ£€æŸ¥å¹¶å¯åŠ¨å¿…è¦å·¥å…·çš„å®‰è£…
  check_required_tools
  
  # é…ç½® oh-my-zsh
  if [[ -d "$HOME/.oh-my-zsh" ]]; then
    setup_omz
  fi
  
  # ç¡®ä¿ fnm ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
  if command -v fnm &>/dev/null; then
    eval "$(command fnm env --use-on-cd)" 2>/dev/null || true
  fi
  
  echo -e "${GREEN}âœ“ zsh é…ç½®åˆå§‹åŒ–å®Œæˆ${NC}"
}

# å¯åŠ¨åˆå§‹åŒ–
init_config

# åŠ è½½ç”¨æˆ·åˆ«åé…ç½®
alias sho='ssh -o ServerAliveInterval=60 '
alias shozc='sho -p 7004 zczx@60.205.149.76'
alias vim='nvim'
alias tmux='TERM=screen-256color tmux -2'
alias proxy='export all_proxy=http://127.0.0.1:1081'
alias unproxy='unset all_proxy'
alias mvnd='mvn clean deploy -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'
alias mvnp='mvn clean package  -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'

# Mavené…ç½®
export MAVEN_HOME=/Users/ab/soft/mvn
export PATH="$PATH:$MAVEN_HOME/bin"
