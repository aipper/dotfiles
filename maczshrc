#!/usr/bin/env zsh

# ===== ä¿®å¤ pnpm é—®é¢˜çš„ä¼˜åŒ–ç‰ˆ zshrc =====
# ç‰ˆæœ¬: 7.1 - ä¿®å¤ Node.js ç¯å¢ƒé—®é¢˜

# ===== å¯åŠ¨æ—¶é—´è®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰ =====
[[ -n "$ZSH_DEBUG" ]] && ZSH_START_TIME=$(($(date +%s%N)/1000000))

# ===== å†å²è®°å½•é…ç½® =====
export HISTFILE="${HOME}/.zsh_history"
export HISTSIZE=100000
export SAVEHIST=100000

setopt EXTENDED_HISTORY SHARE_HISTORY HIST_VERIFY \
       HIST_EXPIRE_DUPS_FIRST HIST_IGNORE_DUPS HIST_IGNORE_ALL_DUPS \
       HIST_FIND_NO_DUPS HIST_IGNORE_SPACE HIST_SAVE_NO_DUPS \
       HIST_REDUCE_BLANKS INC_APPEND_HISTORY

setopt AUTO_CD CORRECT MENU_COMPLETE

# ===== ç¯å¢ƒå˜é‡é…ç½® =====
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PNPM_HOME="$HOME/Library/pnpm"  
export MAVEN_HOME="$HOME/soft/mvn"
export DISPLAY=":0"

# ===== å…³é”®ä¿®å¤ï¼šNode.js ç¯å¢ƒé¢„åˆå§‹åŒ– =====
# æ£€æŸ¥å¹¶é¢„åˆå§‹åŒ– fnm ç¯å¢ƒï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
init_node_env() {
    # é¿å…é‡å¤åˆå§‹åŒ–
    [[ -n "$FNM_INITIALIZED" ]] && return 0
    
    if command -v fnm >/dev/null 2>&1; then
        eval "$(fnm env --use-on-cd --shell zsh)"
        
        # å¦‚æœæœ‰é¡¹ç›®æŒ‡å®šçš„ç‰ˆæœ¬ï¼Œè‡ªåŠ¨ä½¿ç”¨
        if [[ -f .nvmrc ]]; then
            fnm use --silent-if-unchanged 2>/dev/null
        elif [[ -f .node-version ]]; then
            fnm use --silent-if-unchanged 2>/dev/null
        fi
        
        export FNM_INITIALIZED=1
        return 0
    else
        echo "âŒ fnm æœªå®‰è£…æˆ–ä¸å¯ç”¨"
        return 1
    fi
}

# ===== PATH æ„å»ºç­–ç•¥ =====
# æ„å»ºåŸºç¡€ PATHï¼ˆä¸åŒ…å«åŠ¨æ€éƒ¨åˆ†ï¼‰
typeset -a STATIC_PATHS=(
    "/opt/homebrew/bin"
    "/usr/local/bin" 
    "$HOME/bin"
    "$MAVEN_HOME/bin"
    "/usr/bin"
    "/bin"
    "/usr/sbin"
    "/sbin"
)

# åŠ¨æ€ PATH æ„å»ºå‡½æ•°
build_path() {
    typeset -U path  # è‡ªåŠ¨å»é‡
    path=()
    
    # æ·»åŠ é™æ€è·¯å¾„
    for dir in $STATIC_PATHS; do
        [[ -d "$dir" ]] && path+="$dir"
    done
    
    # æ·»åŠ  pnpm è·¯å¾„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    [[ -d "$PNPM_HOME" ]] && path+="$PNPM_HOME"
    
    # æ·»åŠ  fnm è·¯å¾„
    [[ -d "$HOME/.fnm" ]] && path+="$HOME/.fnm"
    
    # æ·»åŠ  Rust è·¯å¾„
    [[ -d "$HOME/.cargo/bin" ]] && path+="$HOME/.cargo/bin"
    
    export PATH
}

# åˆå§‹åŒ– PATH
build_path

# ===== æ™ºèƒ½æ‡’åŠ è½½ç³»ç»Ÿï¼ˆæ”¹è¿›ç‰ˆï¼‰ =====
typeset -A LAZY_LOADED

# Node.js ç›¸å…³å‘½ä»¤çš„ç‰¹æ®Šå¤„ç†
node_command_wrapper() {
    local cmd="$1"
    shift
    
    # ç¡®ä¿ Node.js ç¯å¢ƒå·²åˆå§‹åŒ–
    if ! command -v node >/dev/null 2>&1; then
        init_node_env || {
            echo "âŒ æ— æ³•åˆå§‹åŒ– Node.js ç¯å¢ƒï¼Œè¯·æ£€æŸ¥ fnm å®‰è£…"
            return 1
        }
    fi
    
    # ç§»é™¤åŒ…è£…å‡½æ•°ï¼Œé¿å…é€’å½’
    unfunction "$cmd" 2>/dev/null
    
    # æ‰§è¡ŒåŸå§‹å‘½ä»¤
    if command -v "$cmd" >/dev/null 2>&1; then
        "$cmd" "$@"
    else
        echo "âŒ å‘½ä»¤ '$cmd' ä»ç„¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥å®‰è£…"
        return 1
    fi
}

# Homebrew æ‡’åŠ è½½
lazy_load_brew() {
    local brew_paths=("/opt/homebrew/bin/brew" "/usr/local/bin/brew")
    for brew_path in $brew_paths; do
        [[ -x "$brew_path" ]] && {
            eval "$($brew_path shellenv)"
            build_path  # é‡æ–°æ„å»º PATH
            break
        }
    done
}

# Rust æ‡’åŠ è½½
lazy_load_rust() {
    [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
}

# Oh My Zsh æ‡’åŠ è½½
lazy_load_omz() {
    [[ -d "$HOME/.oh-my-zsh" ]] || return 1
    
    export ZSH="$HOME/.oh-my-zsh"
    ZSH_THEME="robbyrussell"
    DISABLE_AUTO_UPDATE="true"
    
    plugins=(
        git
        z
        zsh-syntax-highlighting
        zsh-autosuggestions
        history-substring-search
    )
    
    source "$ZSH/oh-my-zsh.sh"
    
    # é…ç½® autosuggestions
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=8"
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)
    
    # è®¾ç½®é”®ç›˜ç»‘å®š
    setup_keybindings
}

# ===== å‘½ä»¤åŒ…è£…å™¨æ³¨å†Œ =====
# ä¸º Node.js ç”Ÿæ€å‘½ä»¤åˆ›å»ºç‰¹æ®ŠåŒ…è£…å™¨
node_commands=(fnm node npm npx yarn pnpm)
for cmd in $node_commands; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        eval "
        $cmd() {
            node_command_wrapper $cmd \"\$@\"
        }
        "
    fi
done

# å…¶ä»–å·¥å…·çš„æ‡’åŠ è½½åŒ…è£…å™¨
if ! command -v brew >/dev/null 2>&1; then
    brew() {
        unfunction brew 2>/dev/null
        lazy_load_brew
        brew "$@"
    }
fi

# Rust å·¥å…·
rust_commands=(rustc cargo rustup rust-analyzer)
for cmd in $rust_commands; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        eval "
        $cmd() {
            unfunction $cmd 2>/dev/null
            lazy_load_rust
            $cmd \"\$@\"
        }
        "
    fi
done

# ===== æç¤ºç¬¦ =====
PS1='%F{cyan}%2~%f%(?.%F{green}.%F{red})â¯%f '

# ===== åˆ«åå®šä¹‰ =====
# ç½‘ç»œå’ŒSSH
alias sho='ssh -o ServerAliveInterval=60'
alias shozc='sho -p 7004 zczx@60.205.149.76'
alias proxy='export all_proxy=http://127.0.0.1:7897'
alias unproxy='unset all_proxy'

# å¼€å‘å·¥å…·
alias vim='nvim'
alias tmux='TERM=screen-256color tmux -2'

# Maven
alias mvnd='mvn clean deploy -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'
alias mvnp='mvn clean package -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'

# ç³»ç»Ÿå·¥å…·
alias ll='ls -la'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# ===== é”®ç›˜ç»‘å®šè®¾ç½® =====
setup_keybindings() {
    bindkey '^R' history-incremental-search-backward
    bindkey '^S' history-incremental-search-forward
    bindkey '^A' beginning-of-line
    bindkey '^E' end-of-line
    bindkey '^K' kill-line
    bindkey '^U' kill-whole-line
    
    # å¦‚æœæ”¯æŒå†å²å­å­—ç¬¦ä¸²æœç´¢
    if (( $+functions[history-substring-search-up] )); then
        bindkey '^[[A' history-substring-search-up
        bindkey '^[[B' history-substring-search-down
    fi
}

# ç«‹å³è®¾ç½®åŸºæœ¬é”®ç›˜ç»‘å®š
bindkey '^R' history-incremental-search-backward
bindkey '^S' history-incremental-search-forward

# ===== ä¾¿æ°‘åŠŸèƒ½ =====
# æ˜¾ç¤ºå¼€å‘å·¥å…·å®‰è£…å¸®åŠ©
show_help() {
    cat << 'EOF'
ğŸš€ å¼€å‘ç¯å¢ƒå¿«é€Ÿå®‰è£…æŒ‡å—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Homebrew: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
ğŸš Oh-my-zsh: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/master/tools/install.sh)"
ğŸ“ fnm: brew install fnm
ğŸŸ¢ Node.js: fnm install --lts && fnm default lts
ğŸ¦€ Rust: curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh

ğŸ’¡ ä½¿ç”¨ 'zsh-init' åŠ è½½å®Œæ•´å¢å¼ºåŠŸèƒ½
ğŸ’¡ ä½¿ç”¨ 'check-env' æ£€æŸ¥ç¯å¢ƒçŠ¶æ€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
}

# æ‰‹åŠ¨åˆå§‹åŒ–å®Œæ•´åŠŸèƒ½
zsh-init() {
    lazy_load_omz
    echo "âœ… Zsh å¢å¼ºåŠŸèƒ½å·²åŠ è½½"
}

# ç¯å¢ƒæ£€æŸ¥å·¥å…·
check-env() {
    echo "ğŸ” ç¯å¢ƒçŠ¶æ€æ£€æŸ¥"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Node.js ç¯å¢ƒ
    if command -v node >/dev/null 2>&1; then
        echo "âœ… Node.js: $(node --version)"
        echo "âœ… npm: $(npm --version)"
        [[ -n "$(command -v pnpm)" ]] && echo "âœ… pnpm: $(pnpm --version)"
    else
        echo "âŒ Node.js æœªå¯ç”¨"
        [[ -n "$(command -v fnm)" ]] && echo "ğŸ’¡ fnm å¯ç”¨ï¼Œä½¿ç”¨ 'init_node_env' åˆå§‹åŒ–"
    fi
    
    # å…¶ä»–å·¥å…·
    [[ -n "$(command -v brew)" ]] && echo "âœ… Homebrew: å¯ç”¨"
    [[ -n "$(command -v cargo)" ]] && echo "âœ… Rust: å¯ç”¨"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# é¦–æ¬¡å¯åŠ¨æç¤ºï¼ˆä»…äº¤äº’å¼ shellï¼‰
if [[ $- == *i* ]] && [[ ! -f "$HOME/.zshrc_help_shown" ]]; then
    show_help
    touch "$HOME/.zshrc_help_shown"
    echo
    echo "ğŸ’¡ æç¤ºï¼šä½¿ç”¨ 'check-env' æ£€æŸ¥ç¯å¢ƒï¼Œ'hide-help' éšè—å¸®åŠ©"
fi

# éšè—å¸®åŠ©
hide-help() {
    touch "$HOME/.zshrc_help_shown"
    echo "âœ… å¸®åŠ©ä¿¡æ¯å·²éšè—ï¼Œä½¿ç”¨ 'show_help' å¯é‡æ–°æ˜¾ç¤º"
}

# ===== è°ƒè¯•ä¿¡æ¯ =====
[[ -n "$ZSH_DEBUG" ]] && {
    echo "Zsh é…ç½®åŠ è½½å®Œæˆï¼Œç”¨æ—¶: $(($(date +%s%N)/1000000 - ZSH_START_TIME))ms"
    echo "Node.js ç¯å¢ƒçŠ¶æ€: $(command -v node >/dev/null 2>&1 && echo 'å·²åˆå§‹åŒ–' || echo 'æœªåˆå§‹åŒ–')"
}
