#!/usr/bin/env zsh

# ===== ä¿®å¤ Maven å’Œç¯å¢ƒå˜é‡é—®é¢˜çš„ä¼˜åŒ–ç‰ˆ zshrc =====
# ç‰ˆæœ¬: 7.4 - ä¿®å¤ Maven ä¸ç”Ÿæ•ˆé—®é¢˜

# ===== å¯åŠ¨æ—¶é—´è®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰ =====
[[ -n "$ZSH_DEBUG" ]] && ZSH_START_TIME=$(($(date +%s%N)/1000000))

# ===== å†å²è®°å½•é…ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰ =====
export HISTFILE="${HOME}/.zsh_history"
export HISTSIZE=100000
export SAVEHIST=100000

# ç¡®ä¿å†å²æ–‡ä»¶å­˜åœ¨å¹¶å¯å†™
[[ ! -f "$HISTFILE" ]] && touch "$HISTFILE"
[[ ! -w "$HISTFILE" ]] && chmod 644 "$HISTFILE"

# å†å²è®°å½•é€‰é¡¹è®¾ç½®
setopt EXTENDED_HISTORY          # è®°å½•æ—¶é—´æˆ³
setopt SHARE_HISTORY            # å¤šä¸ªä¼šè¯å…±äº«å†å²
setopt HIST_VERIFY              # å†å²æ‰©å±•æ—¶è¿›è¡ŒéªŒè¯
setopt HIST_EXPIRE_DUPS_FIRST   # åˆ é™¤é‡å¤é¡¹æ—¶ä¼˜å…ˆåˆ é™¤æ—§çš„
setopt HIST_IGNORE_DUPS         # å¿½ç•¥è¿ç»­é‡å¤å‘½ä»¤
setopt HIST_IGNORE_ALL_DUPS     # å¿½ç•¥æ‰€æœ‰é‡å¤å‘½ä»¤
setopt HIST_FIND_NO_DUPS        # æœç´¢æ—¶å¿½ç•¥é‡å¤
setopt HIST_IGNORE_SPACE        # å¿½ç•¥ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_SAVE_NO_DUPS        # ä¿å­˜æ—¶å¿½ç•¥é‡å¤
setopt HIST_REDUCE_BLANKS       # åˆ é™¤å¤šä½™ç©ºæ ¼
setopt INC_APPEND_HISTORY       # ç«‹å³è¿½åŠ åˆ°å†å²æ–‡ä»¶
setopt HIST_BEEP                # å†å²æœç´¢å¤±è´¥æ—¶å“é“ƒ

# å…¶ä»– shell é€‰é¡¹
setopt AUTO_CD CORRECT MENU_COMPLETE

# ===== ç¯å¢ƒå˜é‡é…ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰ =====
# æ£€æµ‹ Maven å®‰è£…ä½ç½®
detect_maven_home() {
    local maven_candidates=(
        "$HOME/soft/mvn"
        "$HOME/apache-maven"
        "$HOME/.m2/wrapper/dists"
        "/opt/homebrew/share/maven"
        "/usr/local/share/maven"
        "/opt/maven"
        "/usr/share/maven"
    )
    
    for candidate in $maven_candidates; do
        if [[ -d "$candidate" && -f "$candidate/bin/mvn" ]]; then
            echo "$candidate"
            return 0
        fi
    done
    
    # é€šè¿‡ which å‘½ä»¤æŸ¥æ‰¾
    local mvn_path=$(which mvn 2>/dev/null)
    if [[ -n "$mvn_path" ]]; then
        # ä» /path/to/maven/bin/mvn æå– /path/to/maven
        echo "${mvn_path%/bin/mvn}"
        return 0
    fi
    
    return 1
}

# è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½® Maven è·¯å¾„
if DETECTED_MAVEN=$(detect_maven_home); then
    export MAVEN_HOME="$DETECTED_MAVEN"
    [[ -n "$ZSH_DEBUG" ]] && echo "ğŸ” æ£€æµ‹åˆ° Maven: $MAVEN_HOME"
else
    # ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼ˆå‘åå…¼å®¹ï¼‰
    export MAVEN_HOME="$HOME/soft/mvn"
    [[ -n "$ZSH_DEBUG" ]] && echo "âš ï¸  ä½¿ç”¨é»˜è®¤ Maven è·¯å¾„: $MAVEN_HOME"
fi

# å…¶ä»–ç¯å¢ƒå˜é‡
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PNPM_HOME="$HOME/Library/pnpm"
export DISPLAY=":0"

# ===== æ”¹è¿›çš„ PATH æ„å»ºç­–ç•¥ =====
# æ„å»ºåŸºç¡€ PATHï¼ˆä¸åŒ…å«åŠ¨æ€éƒ¨åˆ†ï¼‰
typeset -a STATIC_PATHS=(
    "/opt/homebrew/bin"
    "/usr/local/bin" 
    "$HOME/bin"
    "/usr/bin"
    "/bin"
    "/usr/sbin"
    "/sbin"
)

# ä¼˜åŒ–çš„ PATH æ„å»ºå‡½æ•°ï¼ˆä¿®å¤ Maven é—®é¢˜ï¼‰
build_path() {
    typeset -U path  # è‡ªåŠ¨å»é‡
    path=()
    
    # æ·»åŠ é™æ€è·¯å¾„
    for dir in $STATIC_PATHS; do
        [[ -d "$dir" ]] && path+="$dir"
    done
    
    # æ·»åŠ  Maven è·¯å¾„ï¼ˆå¼ºåˆ¶æ·»åŠ ï¼Œä¿®å¤å…³é”®é—®é¢˜ï¼‰
    if [[ -n "$MAVEN_HOME" ]]; then
        local maven_bin="$MAVEN_HOME/bin"
        if [[ -d "$maven_bin" ]]; then
            path+="$maven_bin"
            [[ -n "$ZSH_DEBUG" ]] && echo "âœ… Maven å·²æ·»åŠ åˆ° PATH: $maven_bin"
        else
            # å³ä½¿ç›®å½•æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿå°è¯•æ·»åŠ ï¼ˆå¯èƒ½æ˜¯æƒé™æˆ–æ—¶åºé—®é¢˜ï¼‰
            path+="$maven_bin"
            [[ -n "$ZSH_DEBUG" ]] && echo "âš ï¸  å¼ºåˆ¶æ·»åŠ  Maven åˆ° PATH: $maven_bin"
        fi
    else
        [[ -n "$ZSH_DEBUG" ]] && echo "âŒ MAVEN_HOME æœªè®¾ç½®"
    fi
    
    # æ·»åŠ  pnpm è·¯å¾„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    [[ -d "$PNPM_HOME" ]] && path+="$PNPM_HOME"
    
    # æ·»åŠ  fnm è·¯å¾„ï¼ˆå…³é”®ï¼šç¡®ä¿ fnm å¯æ‰§è¡Œæ–‡ä»¶åœ¨ PATH ä¸­ï¼‰
    [[ -d "$HOME/.fnm" ]] && path+="$HOME/.fnm"
    [[ -d "$HOME/.local/share/fnm" ]] && path+="$HOME/.local/share/fnm"  # fnm é»˜è®¤å®‰è£…è·¯å¾„
    
    # æ·»åŠ  Rust è·¯å¾„
    [[ -d "$HOME/.cargo/bin" ]] && path+="$HOME/.cargo/bin"
    
    # æ·»åŠ  Android SDK è·¯å¾„
    if [[ -n "$ANDROID_HOME" ]]; then
        [[ -d "$ANDROID_HOME/tools" ]] && path+="$ANDROID_HOME/tools"
        [[ -d "$ANDROID_HOME/platform-tools" ]] && path+="$ANDROID_HOME/platform-tools"
    fi
    
    export PATH
    
    # è°ƒè¯•ä¿¡æ¯
    [[ -n "$ZSH_DEBUG" ]] && {
        echo "ğŸ› ï¸  å½“å‰ PATH åŒ…å«çš„å·¥å…·ç›®å½•ï¼š"
        echo "$PATH" | tr ':' '\n' | grep -E "(maven|mvn|cargo|fnm|pnpm)" | sed 's/^/   /'
    }
}

# å¯åŠ¨æ—¶å¼ºåˆ¶ç¡®ä¿ Maven åœ¨ PATH ä¸­
ensure_maven_in_path() {
    if [[ -n "$MAVEN_HOME" && -d "$MAVEN_HOME/bin" ]]; then
        # æ£€æŸ¥ PATH ä¸­æ˜¯å¦å·²åŒ…å« Maven
        if [[ "$PATH" != *"$MAVEN_HOME/bin"* ]]; then
            export PATH="$MAVEN_HOME/bin:$PATH"
            [[ -n "$ZSH_DEBUG" ]] && echo "ğŸ”§ å¼ºåˆ¶æ·»åŠ  Maven åˆ° PATH"
        fi
        
        # éªŒè¯ mvn å‘½ä»¤å¯ç”¨æ€§
        if ! command -v mvn >/dev/null 2>&1; then
            export PATH="$MAVEN_HOME/bin:$PATH"
            [[ -n "$ZSH_DEBUG" ]] && echo "âš ï¸  äºŒæ¬¡ä¿®å¤ï¼šå¼ºåˆ¶é‡æ–°æ·»åŠ  Maven åˆ° PATH"
        fi
    fi
}

# åˆå§‹åŒ– PATH
build_path

# å¯åŠ¨æ—¶ç¡®ä¿ Maven å¯ç”¨ï¼ˆå…³é”®ä¿®å¤ï¼‰
ensure_maven_in_path

# ===== éªŒè¯ Maven å®‰è£… =====
verify_maven() {
    if command -v mvn >/dev/null 2>&1; then
        local mvn_version=$(mvn --version 2>/dev/null | head -1)
        [[ -n "$ZSH_DEBUG" ]] && echo "âœ… Maven å¯ç”¨: $mvn_version"
        return 0
    else
        [[ -n "$ZSH_DEBUG" ]] && echo "âŒ Maven å‘½ä»¤ä¸å¯ç”¨"
        return 1
    fi
}

# åˆå§‹åŒ–æ—¶éªŒè¯ Maven
verify_maven

# ===== å…³é”®ä¿®å¤ï¼šç›´æ¥åˆå§‹åŒ– fnm ç¯å¢ƒ =====
# å¯åŠ¨æ—¶ç›´æ¥åˆå§‹åŒ–ï¼Œä¸å†ä¾èµ–æ‡’åŠ è½½
if command -v fnm >/dev/null 2>&1; then
    # å¯¼å‡º fnm ç¯å¢ƒå˜é‡ï¼Œå¹¶å¯ç”¨ cd æ—¶è‡ªåŠ¨åˆ‡æ¢ Node ç‰ˆæœ¬
    eval "$(fnm env --use-on-cd --shell zsh)"
    
    # è‡ªåŠ¨ä½¿ç”¨é¡¹ç›®æŒ‡å®šçš„ Node ç‰ˆæœ¬ï¼ˆ.nvmrc æˆ– .node-versionï¼‰
    if [[ -f .nvmrc ]]; then
        fnm use --silent-if-unchanged 2>/dev/null
    elif [[ -f .node-version ]]; then
        fnm use --silent-if-unchanged 2>/dev/null
    fi
    
    export FNM_INITIALIZED=1
else
    echo "âŒ fnm æœªå®‰è£…æˆ–ä¸å¯ç”¨ï¼Œå»ºè®®æ‰§è¡Œ: brew install fnm"
fi

# ===== æ™ºèƒ½æ‡’åŠ è½½ç³»ç»Ÿï¼ˆæ”¹è¿›ç‰ˆï¼‰ =====
typeset -A LAZY_LOADED

# Homebrew æ‡’åŠ è½½
lazy_load_brew() {
    local brew_paths=("/opt/homebrew/bin/brew" "/usr/local/bin/brew")
    for brew_path in $brew_paths; do
        [[ -x "$brew_path" ]] && {
            eval "$($brew_path shellenv)"
            build_path  # é‡æ–°æ„å»º PATH
            break
        }
    done
}

# Rust æ‡’åŠ è½½
lazy_load_rust() {
    [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
}

# Oh My Zsh æ‡’åŠ è½½
lazy_load_omz() {
    [[ -d "$HOME/.oh-my-zsh" ]] || return 1
    
    export ZSH="$HOME/.oh-my-zsh"
    ZSH_THEME="robbyrussell"
    DISABLE_AUTO_UPDATE="true"
    
    plugins=(
        git
        z
        zsh-syntax-highlighting
        zsh-autosuggestions
        history-substring-search
    )
    
    source "$ZSH/oh-my-zsh.sh"
    
    # é…ç½® autosuggestions
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=8"
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)
    
    # è®¾ç½®é”®ç›˜ç»‘å®š
    setup_keybindings
}

# ===== å‘½ä»¤åŒ…è£…å™¨æ³¨å†Œ =====
# ä»…ä¿ç•™é Node ç›¸å…³çš„æ‡’åŠ è½½ï¼ˆNode å·²é€šè¿‡ fnm ç›´æ¥åˆå§‹åŒ–ï¼‰

# Homebrew æ‡’åŠ è½½åŒ…è£…å™¨
if ! command -v brew >/dev/null 2>&1; then
    brew() {
        unfunction brew 2>/dev/null
        lazy_load_brew
        brew "$@"
    }
fi

# Rust å·¥å…·æ‡’åŠ è½½
rust_commands=(rustc cargo rustup rust-analyzer)
for cmd in $rust_commands; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        eval "
        $cmd() {
            unfunction $cmd 2>/dev/null
            lazy_load_rust
            $cmd \"\$@\"
        }
        "
    fi
done

# ===== æç¤ºç¬¦ =====
PS1='%F{cyan}%2~%f%(?.%F{green}.%F{red})â¯%f '

# ===== åˆ«åå®šä¹‰ =====
# ç½‘ç»œå’ŒSSH
alias sho='ssh -o ServerAliveInterval=60'
alias shozc='sho -p 7004 zczx@60.205.149.76'
alias proxy='export all_proxy=http://127.0.0.1:7897'
alias unproxy='unset all_proxy'

# å¼€å‘å·¥å…·
alias vim='nvim'
alias tmux='TERM=screen-256color tmux -2'

# Mavenï¼ˆæ”¹è¿›çš„åˆ«åï¼Œæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
alias mvnd='mvn clean deploy -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'
alias mvnp='mvn clean package -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'
alias mvni='mvn clean install -Dmaven.test.skip=true -Dmaven.compile.fork=true -T 1C'
alias mvnt='mvn clean test'
alias mvnv='mvn --version'

# ç³»ç»Ÿå·¥å…·
alias ll='ls -la'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# ===== åŸºç¡€è¡¥å…¨å’Œé”®ç›˜ç»‘å®šï¼ˆä¿®å¤ç‰ˆï¼‰ =====
# å¯ç”¨ zsh å†…ç½®è¡¥å…¨ç³»ç»Ÿ
autoload -Uz compinit
# æ£€æŸ¥è¡¥å…¨æ•°æ®åº“æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆæ¯å¤©æ£€æŸ¥ä¸€æ¬¡ï¼‰
if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C  # è·³è¿‡å®‰å…¨æ£€æŸ¥ä»¥åŠ å¿«å¯åŠ¨é€Ÿåº¦
fi

# è¡¥å…¨æ ·å¼é…ç½®
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' list-colors ''
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'

# ===== å†å²å‘½ä»¤è‡ªåŠ¨å»ºè®®ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ =====
# å®‰è£…å¹¶å¯ç”¨ zsh-autosuggestionsï¼ˆå¦‚æœæœªå®‰è£…åˆ™è‡ªåŠ¨å®‰è£…ï¼‰
ZSH_AUTOSUGGEST_DIR="$HOME/.zsh/zsh-autosuggestions"
if [[ ! -d "$ZSH_AUTOSUGGEST_DIR" ]]; then
    echo "ğŸ“¥ æ­£åœ¨å®‰è£… zsh-autosuggestions..."
    mkdir -p "$HOME/.zsh"
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_AUTOSUGGEST_DIR" 2>/dev/null || {
        echo "âŒ æ— æ³•å®‰è£… zsh-autosuggestionsï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
        echo "ğŸ’¡ æ‰‹åŠ¨å®‰è£…: git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions"
    }
fi

# åŠ è½½ zsh-autosuggestions
if [[ -f "$ZSH_AUTOSUGGEST_DIR/zsh-autosuggestions.zsh" ]]; then
    source "$ZSH_AUTOSUGGEST_DIR/zsh-autosuggestions.zsh"
    
    # é…ç½®è‡ªåŠ¨å»ºè®®
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#666666,underline"  # ç°è‰²ä¸‹åˆ’çº¿
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)           # åŸºäºå†å²å’Œè¡¥å…¨
    ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20                     # æœ€å¤§ç¼“å†²åŒºå¤§å°
    ZSH_AUTOSUGGEST_USE_ASYNC=1                            # å¼‚æ­¥å»ºè®®
    
    echo "âœ… å†å²å‘½ä»¤è‡ªåŠ¨å»ºè®®å·²å¯ç”¨"
else
    echo "âš ï¸  zsh-autosuggestions æœªå®‰è£…ï¼Œå†å²è¡¥å…¨åŠŸèƒ½ä¸å¯ç”¨"
    echo "ğŸ’¡ è¿è¡Œ 'install-autosuggestions' æ‰‹åŠ¨å®‰è£…"
fi

# å®‰è£…è¯­æ³•é«˜äº®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
ZSH_HIGHLIGHT_DIR="$HOME/.zsh/zsh-syntax-highlighting"
if [[ ! -d "$ZSH_HIGHLIGHT_DIR" ]]; then
    echo "ğŸ“¥ æ­£åœ¨å®‰è£… zsh-syntax-highlighting..."
    git clone https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_HIGHLIGHT_DIR" 2>/dev/null
fi

if [[ -f "$ZSH_HIGHLIGHT_DIR/zsh-syntax-highlighting.zsh" ]]; then
    source "$ZSH_HIGHLIGHT_DIR/zsh-syntax-highlighting.zsh"
    echo "âœ… è¯­æ³•é«˜äº®å·²å¯ç”¨"
fi

# ===== é”®ç›˜ç»‘å®šè®¾ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰ =====
setup_keybindings() {
    # åŸºç¡€ç¼–è¾‘å¿«æ·é”®
    bindkey '^A' beginning-of-line
    bindkey '^E' end-of-line
    bindkey '^K' kill-line
    bindkey '^U' kill-whole-line
    bindkey '^W' backward-kill-word
    bindkey '^Y' yank
    
    # å†å²è®°å½•æœç´¢
    bindkey '^R' history-incremental-search-backward
    bindkey '^S' history-incremental-search-forward
    
    # è‡ªåŠ¨å»ºè®®å¿«æ·é”®ï¼ˆé‡è¦ï¼ï¼‰
    if (( $+functions[_zsh_autosuggest_accept] )); then
        bindkey '^F' autosuggest-accept              # Ctrl+F æ¥å—å»ºè®®
        bindkey '^]' autosuggest-accept              # Ctrl+] æ¥å—å»ºè®®  
        bindkey '^ ' autosuggest-accept              # Ctrl+Space æ¥å—å»ºè®®
        bindkey '^E' end-of-line                     # Ctrl+E åˆ°è¡Œå°¾ï¼ˆä¹Ÿä¼šæ¥å—å»ºè®®ï¼‰
        bindkey '^\t' autosuggest-execute            # Ctrl+Tab æ‰§è¡Œå»ºè®®
    fi
    
    # å¦‚æœæœ‰ Oh My Zsh çš„å†å²å­å­—ç¬¦ä¸²æœç´¢æ’ä»¶
    if (( $+functions[history-substring-search-up] )); then
        bindkey '^[[A' history-substring-search-up
        bindkey '^[[B' history-substring-search-down
        bindkey '^P' history-substring-search-up
        bindkey '^N' history-substring-search-down
    else
        # ä½¿ç”¨å†…ç½®çš„å†å²æœç´¢
        bindkey '^[[A' up-line-or-history
        bindkey '^[[B' down-line-or-history
        bindkey '^P' up-line-or-history
        bindkey '^N' down-line-or-history
    fi
    
    # Tab è¡¥å…¨
    bindkey '^I' complete-word
    bindkey '^[[Z' reverse-menu-complete  # Shift+Tab
    
    # å³ç®­å¤´æ¥å—è‡ªåŠ¨å»ºè®®
    if (( $+functions[_zsh_autosuggest_partial_accept] )); then
        bindkey '^[[C' forward-char              # å³ç®­å¤´ï¼šå‘å‰ç§»åŠ¨å…‰æ ‡
        bindkey '^[f' autosuggest-partial-accept # Alt+Fï¼šéƒ¨åˆ†æ¥å—å»ºè®®
    fi
}

# ç«‹å³è®¾ç½®åŸºæœ¬é”®ç›˜ç»‘å®š
setup_keybindings

# ===== Maven ä¸“ç”¨ä¿®å¤å‡½æ•° =====
fix-maven() {
    echo "ğŸ”§ ä¿®å¤ Maven é…ç½®..."
    
    # é‡æ–°æ£€æµ‹ Maven è·¯å¾„
    echo "ğŸ” é‡æ–°æ£€æµ‹ Maven å®‰è£…ä½ç½®..."
    if DETECTED_MAVEN=$(detect_maven_home); then
        export MAVEN_HOME="$DETECTED_MAVEN"
        echo "âœ… æ£€æµ‹åˆ° Maven: $MAVEN_HOME"
    else
        echo "âŒ æœªæ£€æµ‹åˆ° Maven å®‰è£…ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹ä½ç½®ï¼š"
        echo "   - $HOME/soft/mvn"
        echo "   - /opt/homebrew/share/maven"
        echo "   - /usr/local/share/maven"
        echo "ğŸ’¡ æˆ–ä½¿ç”¨ Homebrew å®‰è£…: brew install maven"
        return 1
    fi
    
    # é‡æ–°æ„å»º PATH
    echo "ğŸ”„ é‡æ–°æ„å»º PATH..."
    build_path
    
    # éªŒè¯ Maven
    if command -v mvn >/dev/null 2>&1; then
        local mvn_version=$(mvn --version | head -1)
        echo "âœ… Maven ä¿®å¤æˆåŠŸ: $mvn_version"
        echo "ğŸ“ Maven ä½ç½®: $(which mvn)"
        echo "ğŸ  MAVEN_HOME: $MAVEN_HOME"
    else
        echo "âŒ Maven ä»ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥å®‰è£…"
        return 1
    fi
}

# å®‰è£… Mavenï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
install-maven() {
    echo "ğŸ“¦ å®‰è£… Maven..."
    
    if command -v brew >/dev/null 2>&1; then
        echo "ğŸº é€šè¿‡ Homebrew å®‰è£… Maven..."
        brew install maven
        
        # é‡æ–°æ£€æµ‹å’Œé…ç½®
        fix-maven
    else
        echo "âŒ æœªæ‰¾åˆ° Homebrewï¼Œè¯·æ‰‹åŠ¨å®‰è£… Maven"
        echo "ğŸ’¡ Homebrew å®‰è£…: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
        echo "ğŸ’¡ æˆ–ä»å®˜ç½‘ä¸‹è½½: https://maven.apache.org/download.cgi"
    fi
}

# ===== å†å²è®°å½•ä¿®å¤å‡½æ•° =====
fix-history() {
    echo "ğŸ”§ ä¿®å¤å†å²è®°å½•..."
    
    # æ£€æŸ¥å†å²æ–‡ä»¶
    if [[ ! -f "$HISTFILE" ]]; then
        echo "ğŸ“ åˆ›å»ºå†å²æ–‡ä»¶: $HISTFILE"
        touch "$HISTFILE"
    fi
    
    # æ£€æŸ¥æƒé™
    if [[ ! -w "$HISTFILE" ]]; then
        echo "ğŸ” ä¿®å¤å†å²æ–‡ä»¶æƒé™"
        chmod 644 "$HISTFILE"
    fi
    
    # é‡æ–°åŠ è½½å†å²
    echo "ğŸ”„ é‡æ–°åŠ è½½å†å²è®°å½•"
    fc -R "$HISTFILE"
    
    # æ˜¾ç¤ºå½“å‰å†å²çŠ¶æ€
    echo "ğŸ“Š å†å²æ–‡ä»¶: $HISTFILE"
    echo "ğŸ“Š å†å²è®°å½•æ•°: $(fc -l | wc -l)"
    echo "âœ… å†å²è®°å½•ä¿®å¤å®Œæˆ"
}

# å®‰è£…è‡ªåŠ¨å»ºè®®æ’ä»¶
install-autosuggestions() {
    echo "ğŸ“¥ å®‰è£… zsh-autosuggestions..."
    mkdir -p "$HOME/.zsh"
    
    if git clone https://github.com/zsh-users/zsh-autosuggestions "$HOME/.zsh/zsh-autosuggestions"; then
        echo "âœ… zsh-autosuggestions å®‰è£…æˆåŠŸ"
        echo "ğŸ”„ è¯·é‡æ–°åŠ è½½é…ç½®: source ~/.zshrc"
    else
        echo "âŒ å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ‰‹åŠ¨å®‰è£…"
        echo "ğŸ’¡ æ‰‹åŠ¨å®‰è£…å‘½ä»¤:"
        echo "   git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions"
    fi
}

# æµ‹è¯•è‡ªåŠ¨å»ºè®®åŠŸèƒ½
test-autosuggestions() {
    echo "ğŸ§ª æµ‹è¯•å†å²å‘½ä»¤è‡ªåŠ¨å»ºè®®åŠŸèƒ½..."
    echo
    echo "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•ï¼š"
    echo "1. è¾“å…¥ä¸€ä¸ªå‘½ä»¤ï¼ˆå¦‚: ls -laï¼‰å¹¶æ‰§è¡Œ"
    echo "2. æ¸…ç©ºå½“å‰è¡Œï¼Œç„¶åè¾“å…¥ 'ls'ï¼ˆä¸è¦æŒ‰å›è½¦ï¼‰"
    echo "3. å¦‚æœçœ‹åˆ°ç°è‰²çš„å»ºè®®æ–‡å­—ï¼ŒæŒ‰ä»¥ä¸‹å¿«æ·é”®ï¼š"
    echo "   - Tab æˆ– â†’ é”®ï¼šæ¥å—å»ºè®®"
    echo "   - Ctrl+Fï¼šæ¥å—å»ºè®®"
    echo "   - Ctrl+Eï¼šç§»åˆ°è¡Œå°¾å¹¶æ¥å—å»ºè®®"
    echo
    echo "å¦‚æœæ²¡æœ‰çœ‹åˆ°å»ºè®®ï¼Œè¯·è¿è¡Œ 'install-autosuggestions'"
}

# ===== ä¾¿æ°‘åŠŸèƒ½ =====
# æ˜¾ç¤ºå¼€å‘å·¥å…·å®‰è£…å¸®åŠ©
show_help() {
    cat << 'EOF'
ğŸš€ å¼€å‘ç¯å¢ƒå¿«é€Ÿå®‰è£…æŒ‡å—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Homebrew: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
ğŸš Oh-my-zsh: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/master/tools/install.sh)"
ğŸ“ fnm: brew install fnm
ğŸŸ¢ Node.js: fnm install --lts && fnm default lts
ğŸ¦€ Rust: curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh
ğŸ“š Maven: brew install maven

ğŸ’¡ ä½¿ç”¨ 'zsh-init' åŠ è½½å®Œæ•´å¢å¼ºåŠŸèƒ½
ğŸ’¡ ä½¿ç”¨ 'check-env' æ£€æŸ¥ç¯å¢ƒçŠ¶æ€
ğŸ’¡ ä½¿ç”¨ 'fix-history' ä¿®å¤å†å²è®°å½•é—®é¢˜
ğŸ’¡ ä½¿ç”¨ 'fix-maven' ä¿®å¤ Maven é…ç½®é—®é¢˜
ğŸ’¡ ä½¿ç”¨ 'install-maven' å®‰è£… Maven
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
}

# æ‰‹åŠ¨åˆå§‹åŒ–å®Œæ•´åŠŸèƒ½
zsh-init() {
    lazy_load_omz
    echo "âœ… Zsh å¢å¼ºåŠŸèƒ½å·²åŠ è½½"
    echo "âœ… å†å²æœç´¢å’Œè‡ªåŠ¨è¡¥å…¨å·²å¯ç”¨"
}

# å¢å¼ºçš„ç¯å¢ƒæ£€æŸ¥å·¥å…·
check-env() {
    echo "ğŸ” ç¯å¢ƒçŠ¶æ€æ£€æŸ¥"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # å†å²è®°å½•çŠ¶æ€
    echo "ğŸ“š å†å²è®°å½•çŠ¶æ€ï¼š"
    echo "   æ–‡ä»¶ä½ç½®: $HISTFILE"
    echo "   æ–‡ä»¶å­˜åœ¨: $([[ -f "$HISTFILE" ]] && echo 'âœ…' || echo 'âŒ')"
    echo "   æ–‡ä»¶å¯å†™: $([[ -w "$HISTFILE" ]] && echo 'âœ…' || echo 'âŒ')"
    echo "   è®°å½•æ•°é‡: $(fc -l 2>/dev/null | wc -l | tr -d ' ')"
    echo
    
    # Maven çŠ¶æ€ï¼ˆé‡ç‚¹æ£€æŸ¥ï¼‰
    echo "ğŸ“š Maven çŠ¶æ€ï¼š"
    echo "   MAVEN_HOME: $MAVEN_HOME"
    echo "   ç›®å½•å­˜åœ¨: $([[ -d "$MAVEN_HOME" ]] && echo 'âœ…' || echo 'âŒ')"
    echo "   mvn å‘½ä»¤: $(command -v mvn >/dev/null 2>&1 && echo "âœ… $(which mvn)" || echo 'âŒ ä¸å¯ç”¨')"
    if command -v mvn >/dev/null 2>&1; then
        echo "   ç‰ˆæœ¬ä¿¡æ¯: $(mvn --version | head -1)"
    else
        echo "   ğŸ’¡ ä¿®å¤å»ºè®®: è¿è¡Œ 'fix-maven' æˆ– 'install-maven'"
    fi
    echo
    
    # Node.js ç¯å¢ƒï¼ˆæ–°å¢ fnm çŠ¶æ€æ£€æŸ¥ï¼‰
    echo "ğŸŸ¢ Node.js ç¯å¢ƒï¼š"
    if command -v fnm >/dev/null 2>&1; then
        echo "   fnm: âœ… å·²åˆå§‹åŒ–ï¼ˆç‰ˆæœ¬: $(fnm --version)ï¼‰"
        echo "   å½“å‰ Node.js: $(node --version 2>/dev/null || echo 'âŒ æœªæ¿€æ´»')"
    else
        echo "   fnm: âŒ æœªå®‰è£…æˆ–ä¸å¯ç”¨"
    fi
    [[ -n "$(command -v npm)" ]] && echo "   npm: âœ… $(npm --version)"
    [[ -n "$(command -v pnpm)" ]] && echo "   pnpm: âœ… $(pnpm --version)"
    echo
    
    # å…¶ä»–å·¥å…·
    echo "ğŸ› ï¸  å…¶ä»–å·¥å…·ï¼š"
    [[ -n "$(command -v brew)" ]] && echo "   Homebrew: âœ… å¯ç”¨"
    [[ -n "$(command -v cargo)" ]] && echo "   Rust: âœ… å¯ç”¨"
    [[ -n "$(command -v git)" ]] && echo "   Git: âœ… å¯ç”¨"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# é¦–æ¬¡å¯åŠ¨æç¤ºï¼ˆä»…äº¤äº’å¼ shellï¼‰
if [[ $- == *i* ]] && [[ ! -f "$HOME/.zshrc_help_shown" ]]; then
    show_help
    touch "$HOME/.zshrc_help_shown"
    echo
    echo "ğŸ’¡ æç¤ºï¼šä½¿ç”¨ 'check-env' æ£€æŸ¥ç¯å¢ƒï¼Œ'fix-maven' ä¿®å¤ Maven é—®é¢˜"
fi

# éšè—å¸®åŠ©
hide-help() {
    touch "$HOME/.zshrc_help_shown"
    echo "âœ… å¸®åŠ©ä¿¡æ¯å·²éšè—ï¼Œä½¿ç”¨ 'show_help' å¯é‡æ–°æ˜¾ç¤º"
}

# ===== è°ƒè¯•ä¿¡æ¯ =====
[[ -n "$ZSH_DEBUG" ]] && {
    echo "Zsh é…ç½®åŠ è½½å®Œæˆï¼Œç”¨æ—¶: $(($(date +%s%N)/1000000 - ZSH_START_TIME))ms"
    echo "Maven çŠ¶æ€: $(command -v mvn >/dev/null 2>&1 && echo 'âœ… å¯ç”¨' || echo 'âŒ ä¸å¯ç”¨')"
    echo "Node.js ç¯å¢ƒçŠ¶æ€: $(command -v node >/dev/null 2>&1 && echo 'âœ… å·²åˆå§‹åŒ–' || echo 'âŒ æœªåˆå§‹åŒ–')"
    echo "å†å²è®°å½•çŠ¶æ€: $(fc -l | wc -l) æ¡è®°å½•"
}
