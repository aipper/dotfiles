#!/usr/bin/env zsh

# ===== ç®€æ´ä¼˜é›…çš„ macOS zshrc é…ç½® =====
# ä¸“æ³¨è§£å†³ Mavenã€Android å·¥å…·è·¯å¾„é—®é¢˜
# ç‰ˆæœ¬: 8.0 - ç®€åŒ–ç‰ˆ

# ===== æ ¸å¿ƒç¯å¢ƒå˜é‡é…ç½® =====
# Homebrew è·¯å¾„æ£€æµ‹ï¼ˆæ”¯æŒ Apple Silicon å’Œ Intel Macï¼‰
if [[ -d "/opt/homebrew" ]]; then
    export HOMEBREW_PREFIX="/opt/homebrew"
elif [[ -d "/usr/local/Homebrew" ]]; then
    export HOMEBREW_PREFIX="/usr/local"
fi

export CRS_OAI_KEY=cr_279e648cb0742f462c5b99b84e6ac9d3fc882cb0a55ed6b3c0f9a12bac264f9a


#claude code  

export ANTHROPIC_BASE_URL="https://p.mhao.tech/api"
export ANTHROPIC_AUTH_TOKEN="cr_d2d768943410d8c2cc5c841049aac804ad9a2cf1573702b2dfe520d7097c3c3a"

# å¼€å‘å·¥å…·è·¯å¾„é…ç½®
export HX_HOME=/Applications/HBuilderX.app/Contents/MacOS/
export JAVA_HOME="/Library/Java/JavaVirtualMachines/$(ls /Library/Java/JavaVirtualMachines | head -1)/Contents/Home"
export MAVEN_HOME="$HOMEBREW_PREFIX/share/maven"
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PNPM_HOME="$HOME/Library/pnpm"

# å¦‚æœ Homebrew Maven ä¸å­˜åœ¨ï¼Œå°è¯•å…¶ä»–ä½ç½®
if [[ ! -d "$MAVEN_HOME" ]]; then
    local maven_candidates=(
        "$HOME/soft/mvn"
        "$HOME/.m2/wrapper/dists/apache-maven-*"
        "/opt/maven"
    )
    
    for candidate in $maven_candidates; do
        if [[ -d $candidate && -f $candidate/bin/mvn ]]; then
            export MAVEN_HOME="$candidate"
            break
        fi
    done
fi

# ===== PATH æ„å»º - ç¡®ä¿å·¥å…·å¯ç”¨æ€§ =====
# æ¸…ç†å¹¶é‡å»º PATHï¼ˆé¿å…é‡å¤ï¼‰
typeset -U path  # è‡ªåŠ¨å»é‡

# åŸºç¡€ç³»ç»Ÿè·¯å¾„
path=(
    # Homebrew ä¼˜å…ˆï¼ˆåŒ…å«é€šè¿‡ brew å®‰è£…çš„å·¥å…·ï¼‰
    "$HOMEBREW_PREFIX/bin"
    "$HOMEBREW_PREFIX/sbin"
    
    # å¼€å‘å·¥å…·è·¯å¾„ï¼ˆå…³é”®ï¼‰
    "$MAVEN_HOME/bin"                    # Maven
    "$ANDROID_HOME/platform-tools"      # Android SDK (adb, fastboot)
    "$ANDROID_HOME/tools"               # Android tools
    "$ANDROID_HOME/tools/bin"           # Android tools bin
    "$PNPM_HOME"                        # pnpm
    "$HOME/.cargo/bin"                  # Rust
    "$HOME/.fnm"                        # fnm
    "$HX_HOME"    
    # ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„
    "$HOME/bin"
    "$HOME/.local/bin"
    
    # ç³»ç»Ÿé»˜è®¤è·¯å¾„
    "/usr/local/bin"
    "/usr/bin"
    "/bin"
    "/usr/sbin"
    "/sbin"
)

# è¿‡æ»¤ä¸å­˜åœ¨çš„è·¯å¾„ï¼Œä¿æŒ PATH æ¸…æ´
typeset -a valid_paths
for dir in $path; do
    [[ -d "$dir" ]] && valid_paths+="$dir"
done
path=($valid_paths)

export PATH

# ===== å†å²è®°å½•é…ç½® =====
export HISTFILE="$HOME/.zsh_history"
export HISTSIZE=50000
export SAVEHIST=50000

# ç¡®ä¿å†å²æ–‡ä»¶å­˜åœ¨ä¸”å¯å†™
[[ ! -f "$HISTFILE" ]] && touch "$HISTFILE"

# å†å²è®°å½•é€‰é¡¹
setopt EXTENDED_HISTORY          # è®°å½•æ—¶é—´æˆ³
setopt SHARE_HISTORY            # å¤šä¼šè¯å…±äº«å†å²
setopt HIST_IGNORE_DUPS         # å¿½ç•¥é‡å¤å‘½ä»¤
setopt HIST_IGNORE_ALL_DUPS     # åˆ é™¤æ—§çš„é‡å¤å‘½ä»¤
setopt HIST_IGNORE_SPACE        # å¿½ç•¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_REDUCE_BLANKS       # åˆ é™¤å¤šä½™ç©ºæ ¼
setopt INC_APPEND_HISTORY       # ç«‹å³è¿½åŠ å†å²

# å…¶ä»– shell é€‰é¡¹
setopt AUTO_CD                  # è‡ªåŠ¨ cd
setopt CORRECT                  # å‘½ä»¤çº é”™
setopt MENU_COMPLETE           # èœå•è¡¥å…¨

# ===== Node.js ç¯å¢ƒç®¡ç† (fnm) =====
# åˆå§‹åŒ– fnmï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
if command -v fnm >/dev/null 2>&1; then
    eval "$(fnm env --use-on-cd --shell zsh)"
    
    # è‡ªåŠ¨ä½¿ç”¨é¡¹ç›® Node ç‰ˆæœ¬
    autoload -U add-zsh-hook
    _fnm_autoload_hook() {
        if [[ -f .nvmrc || -f .node-version ]]; then
            fnm use --silent-if-unchanged 2>/dev/null
        fi
    }
    add-zsh-hook chpwd _fnm_autoload_hook
    _fnm_autoload_hook  # å¯åŠ¨æ—¶æ£€æŸ¥
fi

# ===== Homebrew ç¯å¢ƒåˆå§‹åŒ– =====
if [[ -n "$HOMEBREW_PREFIX" && -f "$HOMEBREW_PREFIX/bin/brew" ]]; then
    eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
fi

# ===== Rust ç¯å¢ƒ =====
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"

# ===== è¡¥å…¨ç³»ç»Ÿ =====
autoload -Uz compinit
compinit

# è¡¥å…¨æ ·å¼é…ç½®
zstyle ':completion:*' menu select                                    # èœå•é€‰æ‹©
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'           # å¤§å°å†™ä¸æ•æ„Ÿ
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}               # é¢œè‰²æ”¯æŒ
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'    # æè¿°æ ¼å¼

# ===== è‡ªåŠ¨å»ºè®®å’Œè¯­æ³•é«˜äº® =====
# zsh-autosuggestions
if [[ ! -d "$HOME/.zsh/zsh-autosuggestions" ]]; then
    echo "æ­£åœ¨å®‰è£… zsh-autosuggestions..."
    git clone --quiet https://github.com/zsh-users/zsh-autosuggestions "$HOME/.zsh/zsh-autosuggestions" 2>/dev/null
fi

if [[ -f "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh"
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#666666"
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)
fi

# zsh-syntax-highlighting
if [[ ! -d "$HOME/.zsh/zsh-syntax-highlighting" ]]; then
    echo "æ­£åœ¨å®‰è£… zsh-syntax-highlighting..."
    git clone --quiet https://github.com/zsh-users/zsh-syntax-highlighting "$HOME/.zsh/zsh-syntax-highlighting" 2>/dev/null
fi

if [[ -f "$HOME/.zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    source "$HOME/.zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# ===== é”®ç›˜ç»‘å®š =====
# Emacs é£æ ¼å¿«æ·é”®
bindkey '^A' beginning-of-line      # Ctrl+A è¡Œé¦–
bindkey '^E' end-of-line           # Ctrl+E è¡Œå°¾
bindkey '^K' kill-line             # Ctrl+K åˆ é™¤åˆ°è¡Œå°¾
bindkey '^U' kill-whole-line       # Ctrl+U åˆ é™¤æ•´è¡Œ
bindkey '^W' backward-kill-word    # Ctrl+W åˆ é™¤å•è¯
bindkey '^R' history-incremental-search-backward  # Ctrl+R æœç´¢å†å²

# è‡ªåŠ¨å»ºè®®å¿«æ·é”®
if (( $+functions[_zsh_autosuggest_accept] )); then
    bindkey '^F' autosuggest-accept              # Ctrl+F æ¥å—å»ºè®®
    bindkey '^ ' autosuggest-accept              # Ctrl+Space æ¥å—å»ºè®®
fi

# æ–¹å‘é”®å†å²æœç´¢
bindkey '^[[A' up-line-or-history
bindkey '^[[B' down-line-or-history

# ===== æç¤ºç¬¦ =====
# ç®€æ´çš„æç¤ºç¬¦ï¼Œæ˜¾ç¤ºå½“å‰ç›®å½•å’Œ git åˆ†æ”¯
autoload -Uz vcs_info
precmd() { vcs_info }
zstyle ':vcs_info:git:*' formats '%F{blue}(%b)%f'
setopt PROMPT_SUBST
PROMPT='%F{green}%2~%f ${vcs_info_msg_0_}%F{cyan}â¯%f '

# ===== å®ç”¨åˆ«å =====
# ç³»ç»Ÿå·¥å…·
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# ç½‘ç»œå·¥å…·
alias ping='ping -c 4'
alias myip='curl -s https://httpbin.org/ip | jq -r .origin'

# Git
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'
alias gd='git diff'

# Mavenï¼ˆç¡®ä¿å¯ç”¨æ€§ï¼‰
alias mvn-clean='mvn clean'
alias mvn-compile='mvn compile'
alias mvn-test='mvn test'
alias mvn-package='mvn clean package -DskipTests'
alias mvn-install='mvn clean install -DskipTests'
alias mvn-deploy='mvn clean deploy -DskipTests'

# Android
alias adb-devices='adb devices'
alias adb-logcat='adb logcat'
alias adb-install='adb install -r'

# å¼€å‘å·¥å…·
alias vim='nvim'
alias code='code .'

# ===== å®ç”¨å‡½æ•° =====
# æ£€æŸ¥ç¯å¢ƒçŠ¶æ€
check-env() {
    echo "ğŸ” å¼€å‘ç¯å¢ƒçŠ¶æ€æ£€æŸ¥"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Java
    if command -v java >/dev/null 2>&1; then
        echo "â˜• Java: âœ… $(java -version 2>&1 | head -1)"
        echo "   JAVA_HOME: $JAVA_HOME"
    else
        echo "â˜• Java: âŒ æœªå®‰è£…"
    fi
    
    # Maven
    if command -v mvn >/dev/null 2>&1; then
        echo "ğŸ“¦ Maven: âœ… $(mvn --version | head -1)"
        echo "   ä½ç½®: $(which mvn)"
        echo "   MAVEN_HOME: $MAVEN_HOME"
    else
        echo "ğŸ“¦ Maven: âŒ ä¸å¯ç”¨"
        echo "   ä¿®å¤å‘½ä»¤: brew install maven"
    fi
    
    # Android SDK
    if command -v adb >/dev/null 2>&1; then
        echo "ğŸ¤– Android SDK: âœ… adb $(adb version | head -1)"
        echo "   ä½ç½®: $(which adb)"
        echo "   ANDROID_HOME: $ANDROID_HOME"
    else
        echo "ğŸ¤– Android SDK: âŒ adb ä¸å¯ç”¨"
        echo "   è¯·æ£€æŸ¥ Android Studio å®‰è£…"
    fi
    
    # Node.js
    if command -v node >/dev/null 2>&1; then
        echo "ğŸŸ¢ Node.js: âœ… $(node --version)"
        if command -v fnm >/dev/null 2>&1; then
            echo "   ç®¡ç†å·¥å…·: fnm $(fnm --version)"
        fi
    else
        echo "ğŸŸ¢ Node.js: âŒ æœªå®‰è£…"
        echo "   å®‰è£…å‘½ä»¤: fnm install --lts"
    fi
    
    # å…¶ä»–å·¥å…·
    echo ""
    echo "ğŸ› ï¸  å…¶ä»–å·¥å…·:"
    command -v git >/dev/null 2>&1 && echo "   Git: âœ… $(git --version)"
    command -v brew >/dev/null 2>&1 && echo "   Homebrew: âœ… $(brew --version | head -1)"
    command -v cargo >/dev/null 2>&1 && echo "   Rust: âœ… $(rustc --version)"
    command -v pnpm >/dev/null 2>&1 && echo "   pnpm: âœ… $(pnpm --version)"
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# ä¿®å¤ç¯å¢ƒå˜é‡
fix-env() {
    echo "ğŸ”§ é‡æ–°åŠ è½½ç¯å¢ƒé…ç½®..."
    source ~/.zshrc
    echo "âœ… é…ç½®å·²é‡æ–°åŠ è½½"
    echo "ğŸ’¡ è¿è¡Œ 'check-env' éªŒè¯ç¯å¢ƒçŠ¶æ€"
}

# å¿«é€Ÿå®‰è£…å¼€å‘å·¥å…·
install-dev-tools() {
    echo "ğŸš€ å®‰è£…å¸¸ç”¨å¼€å‘å·¥å…·..."
    
    if ! command -v brew >/dev/null 2>&1; then
        echo "å…ˆå®‰è£… Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    
    echo "å®‰è£…å¼€å‘å·¥å…·..."
    brew install git maven node fnm
    
    echo "å®‰è£… Node.js LTS..."
    fnm install --lts
    fnm default lts
    
    echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆï¼"
    echo "ğŸ”„ è¯·é‡æ–°åŠ è½½é…ç½®: source ~/.zshrc"
}

# ===== å¯åŠ¨ä¼˜åŒ– =====
# å»¶è¿ŸåŠ è½½ Oh My Zshï¼ˆå¯é€‰ï¼‰
if [[ -d "$HOME/.oh-my-zsh" ]] && [[ "$LOAD_OMZ" == "true" ]]; then
    export ZSH="$HOME/.oh-my-zsh"
    ZSH_THEME="robbyrussell"
    plugins=(git z)
    source "$ZSH/oh-my-zsh.sh"
fi

# ===== é¦–æ¬¡è¿è¡Œæç¤º =====
if [[ $- == *i* ]] && [[ ! -f "$HOME/.zshrc_initialized" ]]; then
    echo "ğŸ‰ zsh é…ç½®å·²åŠ è½½ï¼"
    echo ""
    echo "ğŸ’¡ å®ç”¨å‘½ä»¤ï¼š"
    echo "   check-env     - æ£€æŸ¥å¼€å‘ç¯å¢ƒçŠ¶æ€"
    echo "   fix-env       - é‡æ–°åŠ è½½é…ç½®"
    echo "   install-dev-tools - å®‰è£…å¼€å‘å·¥å…·"
    echo ""
    echo "âš¡ å¦‚æœ Maven æˆ– adb å‘½ä»¤ä¸å¯ç”¨ï¼Œè¯·è¿è¡Œ 'check-env' æ£€æŸ¥"
    echo ""
    
    touch "$HOME/.zshrc_initialized"
fi

#THIS MUST BE AT THE END OF THE FILE FOR SDKMAN TO WORK!!!
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"

